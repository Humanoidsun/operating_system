## 四、硬件中断
硬件中断分为外设中断和处理器间中断(`IPI`)，下面我们先来看一下外设中断。


### 4.1 外设中断
外设中断和软件中断有一个很大的不同，软件中断是CPU自己给自己发送中断，而外设中断是需要外设发送中断给CPU。外设想要给CPU发送中断，那就必须要连接到CPU，不可能隔空发送。那么怎么连接呢，如果所有外设都直接连到CPU，显然是不可能的。因为一个计算机系统中的外设是非常多的，而且多种多样，CPU无法提前为所有外设设计和预留接口。所以需要一个中间设备，就像秘书一样替CPU连接到所有的外设并接收中断信号，再转发给CPU，这个设备就叫做中断控制器(`Interrupt Controller`)。

在`x86`上，在`UP`时代的时候，有一个中断控制器叫做`PIC`(`Programmable Interrupt Controller`)。所有的外设都连接到`PIC`上，`PIC`再连接到CPU的中断引脚上。外设给`PIC`发中断，`PIC`再把中断转发给CPU。由于`PIC`的设计问题，一个`PIC`只能连接8个外设，所以后来把两个`PIC`级联起来，第二个`PIC`连接到第一个`PIC`的一个引脚上，这样一共能连接15个外设。

到了`SMP`时代的时候，`PIC`显然不能胜任工作了，于是`Intel`开发了`APIC`(`Advanced PIC`)。`APIC`分为两个部分：

- 一部分是`Local APIC`，有`NR_CPU`个，每个CPU都连接一个`Local APIC`；

- 一部分是`IO APIC`，只有一个，所有的外设都连接到这个`IO APIC`上。

`IO APIC`连接到所有的`Local APIC`上，当外设向`IO APIC`发送中断时，`IO APIC`会把中断信号转发给某个`Local APIC`。有些`per CPU`的设备是直接连接到`Local APIC`的，可以通过`Local APIC`直接给自己的CPU发送中断。

外设中断并不是直接分配中断向量号，而是直接分配`IRQ`号，然后`IRQ+32`就是其中断向量号。有些外设的`IRQ`是内核预先设定好的，有些是行业默认的`IRQ`号。

关于`APIC`的细节这里就不再阐述了，推荐大家去看《`Interrupt in Linux` (硬件篇)》，对`APIC`讲的比较详细。


### 4.2 处理器间中断
在`SMP`系统中，多个CPU之间有时候也需要发送消息，于是就产生了处理器间中断(`IPI`)。`IPI`既像软件中断又像硬件中断，它的产生像软件中断，是在程序中用代码发送的，而它的处理像硬件中断，是异步的。我们这里把`IPI`看作是硬件中断，因为一个CPU可以把另外一个CPU看做外设，就相当于是外设发来的中断。
